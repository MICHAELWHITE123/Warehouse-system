#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ API
echo "๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ Warehouse Management System..."

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ัะตัะฒะตัะฐ
cd "$(dirname "$0")"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะตะดัะดััะธะต ะฟัะพัะตััั ะฝะฐ ะฟะพััั 3001
echo "๐ง ะัะฒะพะฑะพะถะดะฐะตะผ ะฟะพัั 3001..."
lsof -ti:3001 | xargs kill -9 2>/dev/null || true
pkill -f "node.*index" 2>/dev/null || true

# ะะดะตะผ ะฝะตะผะฝะพะณะพ
sleep 2

# ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั
echo "๐จ ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ..."
npm run build

if [ $? -eq 0 ]; then
    echo "โ ะกะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ"
    
    # ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั
    echo "๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ..."
    node dist/index.js > server.log 2>&1 &
    
    SERVER_PID=$!
    echo "๐ PID ัะตัะฒะตัะฐ: $SERVER_PID"
    
    # ะะดะตะผ ะทะฐะฟััะบะฐ
    sleep 3
    
    # ะัะพะฒะตััะตะผ, ััะพ ัะตัะฒะตั ัะฐะฑะพัะฐะตั
    if curl -s http://localhost:3001/api/ > /dev/null; then
        echo "โ ะกะตัะฒะตั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
        echo "๐ API ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: http://localhost:3001/api/"
        echo "๐ Health check: http://localhost:3001/health"
        echo "๐ ะะพะณะธ ัะตัะฒะตัะฐ ะฒ ัะฐะนะปะต: server.log"
        echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ ัะตัะฒะตัะฐ: kill $SERVER_PID"
    else
        echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ. ะัะพะฒะตัััะต ะปะพะณะธ ะฒ server.log"
        cat server.log
    fi
else
    echo "โ ะัะธะฑะบะฐ ัะฑะพัะบะธ ะฟัะพะตะบัะฐ"
    exit 1
fi
